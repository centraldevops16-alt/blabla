import json
import boto3
import time
import re

ssm = boto3.client("ssm")
ec2 = boto3.client("ec2")
sts = boto3.client("sts")
ses = boto3.client("ses")

SSM_DOCUMENT_NAME = "CheckMiddlewareVersions"
SES_SOURCE_EMAIL = "remediation@example.com"
DEFAULT_OWNER_DL = "team@example.com"


def get_account_id():
    return sts.get_caller_identity()["Account"]


def get_instance_name(instance):
    tags = instance.get("Tags", [])
    for tag in tags:
        if tag["Key"] == "Name":
            return tag["Value"]
    return "(no Name tag)"


def get_tag_value(instance, key):
    tags = instance.get("Tags", [])
    for tag in tags:
        if tag["Key"] == key:
            return tag["Value"]
    return "(not set)"


def get_owner_dl(instance_id):
    resp = ec2.describe_instances(InstanceIds=[instance_id])
    instance = resp["Reservations"][0]["Instances"][0]
    tags = instance.get("Tags", [])
    for tag in tags:
        if tag["Key"].lower() == "ownerdl":
            return tag["Value"]
    return DEFAULT_OWNER_DL


def get_instance_os(instance):
    platform = instance.get("Platform", "")
    platform_details = instance.get("PlatformDetails", "").lower()

    if platform == "windows" or "windows" in platform_details:
        return "Windows"
    return "Linux"


def wait_for_ssm_command(command_id, instance_id, timeout_sec=300):
    for _ in range(timeout_sec // 5):
        resp = ssm.get_command_invocation(
            CommandId=command_id,
            InstanceId=instance_id
        )
        status = resp["Status"]
        if status in ["Success", "Failed", "Cancelled", "TimedOut"]:
            return resp
        time.sleep(5)
    raise RuntimeError("SSM command timed out")


def parse_obsolete_lines(stdout):
    obsolete = []
    latest_versions = {}
    for line in stdout.splitlines():
        line = line.strip()
        if "(obsolete, latest" in line:
            obsolete.append(line)
            # Extract middleware name and latest version
            m = re.match(r"^([^:]+):.*\(obsolete, latest ([^)]+)\)", line)
            if m:
                mw = m.group(1).strip()
                latest = m.group(2).strip()
                latest_versions[mw] = latest
    return obsolete, latest_versions


def send_obsolete_middleware_email(
    account_id,
    instance_id,
    instance_name,
    region,
    vpc_id,
    private_ip,
    state,
    os_type,
    environment,
    team,
    obsolete_list,
    latest_versions,
    to_email
):
    if not obsolete_list:
        return

    subject = f"Obsolete middleware detected on {instance_name} ({instance_id})"

    # Build “Latest version available” section
    latest_lines = []
    for mw, latest in latest_versions.items():
        latest_lines.append(f"{mw}: {latest}")

    body = f"""
AWS Account ID: {account_id}
Region: {region}
Instance ID: {instance_id}
Instance Name: {instance_name}
State: {state}
VPC ID: {vpc_id}
Private IP: {private_ip}
OS: {os_type}
Environment: {environment}
Team: {team}

The following middleware versions are obsolete and should be updated:

{chr(10).join([f'- {mw}' for mw in obsolete_list])}

Latest version available (from official sites):

{chr(10).join([f'- {line}' for line in latest_lines])}

Please plan an update to the latest stable version.
    """.strip()

    ses.send_email(
        Source=SES_SOURCE_EMAIL,
        Destination={"ToAddresses": [to_email]},
        Message={
            "Subject": {"Data": subject},
            "Body": {"Text": {"Data": body}}
        }
    )


def lambda_handler(event, context):
    account_id = get_account_id()
    region = context.invoked_function_arn.split(":")[3]

    # Get all running instances
    paginator = ec2.get_paginator("describe_instances")
    instance_ids = []
    for page in paginator.paginate(
        Filters=[
            {"Name": "instance-state-name", "Values": ["running"]}
        ]
    ):
        for reservation in page["Reservations"]:
            for instance in reservation["Instances"]:
                instance_ids.append(instance["InstanceId"])

    results = []

    for instance_id in instance_ids:
        resp = ec2.describe_instances(InstanceIds=[instance_id])
        instance = resp["Reservations"][0]["Instances"][0]

        instance_name = get_instance_name(instance)
        vpc_id = instance.get("VpcId", "unknown")
        private_ip = instance.get("PrivateIpAddress", "unknown")
        state = instance["State"]["Name"]
        os_type = get_instance_os(instance)
        environment = get_tag_value(instance, "Environment")
        team = get_tag_value(instance, "Team")
        to_email = get_owner_dl(instance_id)

        # Run SSM document to check versions
        ssm_resp = ssm.send_command(
            InstanceIds=[instance_id],
            DocumentName=SSM_DOCUMENT_NAME,
            Parameters={"OS": [os_type]},
            Comment=f"Check middleware versions on {instance_id}"
        )
        command_id = ssm_resp["Command"]["CommandId"]

        # Wait for completion
        ssm_result = wait_for_ssm_command(command_id, instance_id)

        stdout = ssm_result.get("StandardOutputContent", "")
        obsolete_list, latest_versions = parse_obsolete_lines(stdout)

        # Send email only if obsolete versions found
        send_obsolete_middleware_email(
            account_id=account_id,
            instance_id=instance_id,
            instance_name=instance_name,
            region=region,
            vpc_id=vpc_id,
            private_ip=private_ip,
            state=state,
            os_type=os_type,
            environment=environment,
            team=team,
            obsolete_list=obsolete_list,
            latest_versions=latest_versions,
            to_email=to_email
        )

        results.append({
            "InstanceId": instance_id,
            "InstanceName": instance_name,
            "OS": os_type,
            "CommandId": command_id,
            "Status": ssm_result["Status"],
            "ObsoleteCount": len(obsolete_list),
            "ToEmail": to_email
        })

    return {
        "statusCode": 200,
        "body": json.dumps(results)
    }
