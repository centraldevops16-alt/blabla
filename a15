def send_obsolete_middleware_email(
    account_id: str,
    instance_id: str,
    instance_name: str,
    region: str,
    vpc_id: str,
    private_ip: str,
    state: str,
    os_type: str,
    environment: str,
    team: str,
    obsolete_list,
    latest_versions,
    to_email: str,
):
    if not obsolete_list:
        logger.info(f"No obsolete middleware for instance {instance_id} {instance_name}")
        return

    subject = f"Obsolete middleware detected on {instance_name} ({instance_id})"

    latest_lines = []
    for mw, latest in latest_versions.items():
        url = MIDDLEWAREDOWNLOADURLS.get(mw)
        if url:
            latest_lines.append(f"<li><b>{mw}</b>: {latest} &ndash; <a href=\"{url}\">{url}</a></li>")
        else:
            latest_lines.append(f"<li><b>{mw}</b>: {latest}</li>")

    obsolete_items = [
        f"<li>{line}</li>"
        for line in obsolete_list
    ]

    html_body = f"""
<html>
  <body>
    <p><b>AWS Account ID:</b> {account_id}<br/>
       <b>Region:</b> {region}<br/>
       <b>Instance ID:</b> {instance_id}<br/>
       <b>Instance Name:</b> {instance_name}<br/>
       <b>State:</b> {state}<br/>
       <b>VPC ID:</b> {vpc_id}<br/>
       <b>Private IP:</b> {private_ip}<br/>
       <b>OS:</b> {os_type}<br/>
       <b>Environment:</b> {environment}<br/>
       <b>Team:</b> {team}</p>

    <p><b>Obsolete middleware detected:</b></p>
    <ul>
      {''.join(obsolete_items)}
    </ul>

    <p><b>Latest versions from official sites:</b></p>
    <ul>
      {''.join(latest_lines)}
    </ul>

    <p>Please plan an update to the latest stable version.</p>
  </body>
</html>
""".strip()

    # Optional: keep a plain-text fallback for clients that don't render HTML
    text_body = f"""AWS Account ID: {account_id}
Region: {region}
Instance ID: {instance_id}
Instance Name: {instance_name}
State: {state}
VPC ID: {vpc_id}
Private IP: {private_ip}
OS: {os_type}
Environment: {environment}
Team: {team}

The following middleware versions are obsolete and should be updated:
{chr(10).join(f"- {line}" for line in obsolete_list)}

Latest version available from official sites:
{chr(10).join(f"- {mw}: {latest_versions[mw]}" for mw in latest_versions)}

Please plan an update to the latest stable version.
""".strip()

    ses.send_email(
        Source=SESSOURCEEMAIL,
        Destination={'ToAddresses': [to_email]},
        Message={
            'Subject': {'Data': subject},
            'Body': {
                'Text': {'Data': text_body},
                'Html': {'Data': html_body},
            },
        },
    )
    logger.info(
        f"Email sent: InstanceId {instance_id}, InstanceName {instance_name}, "
        f"ToEmail {to_email}, ObsoleteCount {len(obsolete_list)}"
    )
