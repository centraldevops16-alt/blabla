{
  "schemaVersion": "2.2",
  "description": "Check installed middleware versions and compare against latest from official sites; skip gracefully if tools are missing",
  "parameters": {
    "OS": {
      "type": "String",
      "description": "OS type: Linux or Windows",
      "default": "Linux"
    }
  },
  "mainSteps": [
    {
      "name": "CheckLinuxVersions",
      "action": "aws:runShellScript",
      "precondition": {
        "StringEquals": [
          "{{OS}}",
          "Linux"
        ]
      },
      "inputs": {
        "runCommand": [
          "#!/bin/bash",
          "echo \"Checking installed middleware versions on RHEL\"",
          "",
          "# Helper: compare versions",
          "version_lt() {",
          "  local v1=$(echo \"$1\" | sed 's/-.*//')",
          "  local v2=$(echo \"$2\" | sed 's/-.*//')",
          "  [ \"$(printf '%s\\n' \"$v1\" \"$v2\" | sort -V | head -n1)\" = \"$v1\" ] && [ \"$v1\" != \"$v2\" ]",
          "}",
          "",
          "# Java – scrape latest from Oracle downloads",
          "latest_java=$(curl -s https://www.oracle.com/java/technologies/downloads/ | grep -oE 'Java SE [0-9]+\\.[0-9]+\\.[0-9]+' | head -n1 | sed -E 's/Java SE ([0-9]+\\.[0-9]+\\.[0-9]+)/\\1/')",
          "if [ -z \"$latest_java\" ]; then",
          "  echo \"Warning: could not fetch latest Java version, skipping comparison.\" >&2",
          "  if command -v java >/dev/null 2>&1; then",
          "    java_version=$(java -version 2>&1 | head -n1 | sed -E 's/.*\"(.*)\".*/\\1/')",
          "    echo \"Java: $java_version (no latest available)\"",
          "  else",
          "    echo \"Java: not installed\"",
          "  fi",
          "else",
          "  if command -v java >/dev/null 2>&1; then",
          "    java_version=$(java -version 2>&1 | head -n1 | sed -E 's/.*\"(.*)\".*/\\1/')",
          "    if version_lt \"$java_version\" \"$latest_java\"; then",
          "      echo \"Java: $java_version (obsolete, latest $latest_java)\"",
          "    else",
          "      echo \"Java: $java_version (ok)\"",
          "    fi",
          "  else",
          "    echo \"Java: not installed\"",
          "  fi",
          "fi",
          "",
          "# Tomcat – use common paths and skip if not found",
          "tomcat_version=\"\"",
          "if [ -x /opt/tomcat/bin/catalina.sh ]; then",
          "  tomcat_version=$(/opt/tomcat/bin/catalina.sh version 2>&1 | grep 'Server version' | sed -E 's/.*Apache Tomcat\\/([^ ]+).*/\\1/')",
          "elif command -v catalina.sh >/dev/null 2>&1; then",
          "  tomcat_version=$(catalina.sh version 2>&1 | grep 'Server version' | sed -E 's/.*Apache Tomcat\\/([^ ]+).*/\\1/')",
          "fi",
          "latest_tomcat=$(curl -s https://tomcat.apache.org/whichversion.html | grep -oE 'Latest Released Version\\|[0-9]+\\.[0-9]+\\.[0-9]+' | head -n1 | sed -E 's/Latest Released Version\\|([0-9]+\\.[0-9]+\\.[0-9]+)/\\1/')",
          "if [ -z \"$latest_tomcat\" ]; then",
          "  echo \"Warning: could not fetch latest Tomcat version, skipping comparison.\" >&2",
          "  if [ -n \"$tomcat_version\" ]; then",
          "    echo \"Tomcat: $tomcat_version (no latest available)\"",
          "  else",
          "    echo \"Tomcat: not installed\"",
          "  fi",
          "else",
          "  if [ -n \"$tomcat_version\" ] && version_lt \"$tomcat_version\" \"$latest_tomcat\"; then",
          "    echo \"Tomcat: $tomcat_version (obsolete, latest $latest_tomcat)\"",
          "  elif [ -n \"$tomcat_version\" ]; then",
          "    echo \"Tomcat: $tomcat_version (ok)\"",
          "  else",
          "    echo \"Tomcat: not installed\"",
          "  fi",
          "fi",
          "",
          "# Apache HTTP Server – use common paths",
          "apache_version=\"\"",
          "if command -v httpd >/dev/null 2>&1; then",
          "  apache_version=$(httpd -v | grep 'Server version' | sed -E 's/.*Apache\\/([^ ]+).*/\\1/')",
          "elif [ -x /usr/sbin/httpd ]; then",
          "  apache_version=$(/usr/sbin/httpd -v | grep 'Server version' | sed -E 's/.*Apache\\/([^ ]+).*/\\1/')",
          "fi",
          "latest_apache=$(curl -s https://httpd.apache.org | grep -oE 'Apache HTTP Server [0-9]+\\.[0-9]+\\.[0-9]+' | head -n1 | sed -E 's/Apache HTTP Server ([0-9]+\\.[0-9]+\\.[0-9]+)/\\1/')",
          "if [ -z \"$latest_apache\" ]; then",
          "  echo \"Warning: could not fetch latest Apache version, skipping comparison.\" >&2",
          "  if [ -n \"$apache_version\" ]; then",
          "    echo \"Apache: $apache_version (no latest available)\"",
          "  else",
          "    echo \"Apache: not installed\"",
          "  fi",
          "else",
          "  if [ -n \"$apache_version\" ] && version_lt \"$apache_version\" \"$latest_apache\"; then",
          "    echo \"Apache: $apache_version (obsolete, latest $latest_apache)\"",
          "  elif [ -n \"$apache_version\" ]; then",
          "    echo \"Apache: $apache_version (ok)\"",
          "  else",
          "    echo \"Apache: not installed\"",
          "  fi",
          "fi",
          "",
          "# JBoss – use common path",
          "jboss_version=\"\"",
          "if [ -x /opt/jboss/bin/standalone.sh ]; then",
          "  jboss_version=$(/opt/jboss/bin/standalone.sh --version 2>&1 | head -n1 | sed -E 's/.*([0-9]+\\.[0-9]+\\.[0-9]+).*/\\1/')",
          "fi",
          "latest_jboss=$(curl -s https://www.jboss.org | grep -oE 'JBoss EAP [0-9]+\\.[0-9]+\\.[0-9]+' | head -n1 | sed -E 's/JBoss EAP ([0-9]+\\.[0-9]+\\.[0-9]+)/\\1/')",
          "if [ -z \"$latest_jboss\" ]; then",
          "  latest_jboss=\"7.4.0\"",
          "fi",
          "if [ -n \"$jboss_version\" ] && version_lt \"$jboss_version\" \"$latest_jboss\"; then",
          "  echo \"JBoss: $jboss_version (obsolete, latest $latest_jboss)\"",
          "elif [ -n \"$jboss_version\" ]; then",
          "  echo \"JBoss: $jboss_version (ok)\"",
          "else",
          "  echo \"JBoss: not installed\"",
          "fi",
          "",
          "# Python – scrape latest from python.org",
          "latest_python=$(curl -s https://www.python.org/downloads/ | grep -oE 'Download Python [0-9]+\\.[0-9]+\\.[0-9]+' | head -n1 | sed -E 's/Download Python ([0-9]+\\.[0-9]+\\.[0-9]+)/\\1/')",
          "if [ -z \"$latest_python\" ]; then",
          "  echo \"Warning: could not fetch latest Python version, skipping comparison.\" >&2",
          "  if command -v python3 >/dev/null 2>&1; then",
          "    python_version=$(python3 --version 2>&1 | sed -E 's/Python ([^ ]+).*/\\1/')",
          "    echo \"Python: $python_version (no latest available)\"",
          "  else",
          "    echo \"Python: not installed\"",
          "  fi",
          "else",
          "  if command -v python3 >/dev/null 2>&1; then",
          "    python_version=$(python3 --version 2>&1 | sed -E 's/Python ([^ ]+).*/\\1/')",
          "    if [ -n \"$python_version\" ] && version_lt \"$python_version\" \"$latest_python\"; then",
          "      echo \"Python: $python_version (obsolete, latest $latest_python)\"",
          "    elif [ -n \"$python_version\" ]; then",
          "      echo \"Python: $python_version (ok)\"",
          "    else",
          "      echo \"Python: unknown version\"",
          "    fi",
          "  else",
          "    echo \"Python: not installed\"",
          "  fi",
          "fi"
        ]
      }
    },
    {
      "name": "CheckWindowsVersions",
      "action": "aws:runPowerShellScript",
      "precondition": {
        "StringEquals": [
          "{{OS}}",
          "Windows"
        ]
      },
      "inputs": {
        "runCommand": [
          "Write-Host \"Checking installed middleware versions on Windows Server 2019\"",
          "",
          "# Helper: compare versions",
          "function Version-LT ($v1, $v2) {",
          "  $v1Parts = [version]$v1",
          "  $v2Parts = [version]$v2",
          "  return $v1Parts -lt $v2Parts",
          "}",
          "",
          "# Java – only if java is available",
          "$latestJava = $null",
          "try {",
          "  $html = Invoke-WebRequest -Uri \"https://www.oracle.com/java/technologies/downloads/\" -UseBasicParsing",
          "  if ($html.Content -match 'Java SE ([0-9]+\\.[0-9]+\\.[0-9]+)') {",
          "    $latestJava = $matches[1]",
          "  }",
          "} catch {",
          "  Write-Warning \"Could not fetch latest Java version, skipping comparison.\"",
          "}",
          "$javaVersion = $null",
          "if (Get-Command java -ErrorAction SilentlyContinue) {",
          "  $javaVersion = (java -version 2>&1) -match '\"' | % { $_ -replace '.*\"(.*)\".*', '$1' }",
          "}",
          "if ($javaVersion -and $latestJava) {",
          "  if (Version-LT $javaVersion $latestJava) {",
          "    Write-Output \"Java: $javaVersion (obsolete, latest $latestJava)\"",
          "  } else {",
          "    Write-Output \"Java: $javaVersion (ok)\"",
          "  }",
          "} elseif ($javaVersion) {",
          "  Write-Output \"Java: $javaVersion (no latest available)\"",
          "} else {",
          "  Write-Output \"Java: not installed\"",
          "}",
          "",
          "# Tomcat – only if CATALINA_HOME and version.bat exist",
          "$latestTomcat = $null",
          "try {",
          "  $html = Invoke-WebRequest -Uri \"https://tomcat.apache.org/whichversion.html\" -UseBasicParsing",
          "  if ($html.Content -match 'Latest Released Version\\|([0-9]+\\.[0-9]+\\.[0-9]+)') {",
          "    $latestTomcat = $matches[1]",
          "  }",
          "} catch {",
          "  Write-Warning \"Could not fetch latest Tomcat version, skipping comparison.\"",
          "}",
          "$tomcatVersion = $null",
          "if ($env:CATALINA_HOME -and (Test-Path \"$env:CATALINA_HOME\\bin\\version.bat\")) {",
          "  $tomcatVersion = & \"$env:CATALINA_HOME\\bin\\version.bat\" 2>&1 | Select-String 'Server version' | ForEach-Object { $_ -replace '.*Apache Tomcat\\/([^ ]+).*', '$1' }",
          "}",
          "if ($tomcatVersion -and $latestTomcat) {",
          "  if (Version-LT $tomcatVersion $latestTomcat) {",
          "    Write-Output \"Tomcat: $tomcatVersion (obsolete, latest $latestTomcat)\"",
          "  } else {",
          "    Write-Output \"Tomcat: $tomcatVersion (ok)\"",
          "  }",
          "} elseif ($tomcatVersion) {",
          "  Write-Output \"Tomcat: $tomcatVersion (no latest available)\"",
          "} else {",
          "  Write-Output \"Tomcat: not installed\"",
          "}",
          "",
          "# Visual C++ – check redistributable versions via registry",
          "$latestVC = $null",
          "try {",
          "  $html = Invoke-WebRequest -Uri \"https://learn.microsoft.com/en-us/cpp/windows/latest-supported-vc-redist?view=msvc-170\" -UseBasicParsing",
          "  if ($html.Content -match 'Latest Microsoft Visual C\\+\\+ Redistributable Version\\s*`([0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)`') {",
          "    $latestVC = $matches[1]",
          "  } elseif ($html.Content -match 'Latest Microsoft Visual C\\+\\+ Redistributable Version\\s*\\|\\s*([0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+)\\s*\\|') {",
          "    $latestVC = $matches[1]",
          "  }",
          "} catch {",
          "  Write-Warning \"Could not fetch latest Visual C++ version, skipping comparison.\"",
          "}",
          "$vcKeys = Get-ChildItem 'HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall','HKLM:\\SOFTWARE\\Wow6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall' -ErrorAction SilentlyContinue |",
          "  Where-Object { $_.GetValue('DisplayName') -match 'Microsoft Visual C\\+\\+\\s*\\d{4}.*Redistributable.*' }",
          "if ($vcKeys) {",
          "  $installedVC = $vcKeys | ForEach-Object {",
          "    $displayName = $_.GetValue('DisplayName')",
          "    $version = $_.GetValue('DisplayVersion')",
          "    if ($version -match '\\d+\\.\\d+\\.\\d+\\.\\d+') {",
          "      $version",
          "    }",
          "  } | Sort-Object { [version]$_ } -Descending | Select-Object -First 1",
          "  if ($installedVC) {",
          "    if ($latestVC) {",
          "      if (Version-LT $installedVC $latestVC) {",
          "        Write-Output \"Visual C++: $installedVC (obsolete, latest $latestVC)\"",
          "      } else {",
          "        Write-Output \"Visual C++: $installedVC (ok)\"",
          "      }",
          "    } else {",
          "      Write-Output \"Visual C++: $installedVC (no latest available)\"",
          "    }",
          "  } else {",
          "    Write-Output \"Visual C++: installed (version unknown)\"",
          "  }",
          "} else {",
          "  Write-Output \"Visual C++: not installed\"",
          "}",
          "",
          "# Apache HTTP Server – only if httpd is available",
          "$latestApache = $null",
          "try {",
          "  $html = Invoke-WebRequest -Uri \"https://httpd.apache.org\" -UseBasicParsing",
          "  if ($html.Content -match 'Apache HTTP Server ([0-9]+\\.[0-9]+\\.[0-9]+)') {",
          "    $latestApache = $matches[1]",
          "  }",
          "} catch {",
          "  Write-Warning \"Could not fetch latest Apache version, skipping comparison.\"",
          "}",
          "$apacheVersion = $null",
          "if (Get-Command httpd -ErrorAction SilentlyContinue) {",
          "  $apacheVersion = (httpd -v 2>&1) -match 'Server version' | ForEach-Object { $_ -replace '.*Apache\\/([^ ]+).*', '$1' }",
          "}",
          "if ($apacheVersion -and $latestApache) {",
          "  if (Version-LT $apacheVersion $latestApache) {",
          "    Write-Output \"Apache: $apacheVersion (obsolete, latest $latestApache)\"",
          "  } else {",
          "    Write-Output \"Apache: $apacheVersion (ok)\"",
          "  }",
          "} elseif ($apacheVersion) {",
          "  Write-Output \"Apache: $apacheVersion (no latest available)\"",
          "} else {",
          "  Write-Output \"Apache: not installed\"",
          "}",
          "",
          "# JBoss – only if JBOSS_HOME and standalone.bat exist",
          "$latestJBoss = \"7.4.0\"",
          "try {",
          "  $html = Invoke-WebRequest -Uri \"https://www.jboss.org\" -UseBasicParsing",
          "  if ($html.Content -match 'JBoss EAP ([0-9]+\\.[0-9]+\\.[0-9]+)') {",
          "    $latestJBoss = $matches[1]",
          "  }",
          "} catch {",
          "  Write-Warning \"Could not fetch latest JBoss version, using fallback $latestJBoss\"",
          "}",
          "$jbossVersion = $null",
          "if ($env:JBOSS_HOME -and (Test-Path \"$env:JBOSS_HOME\\bin\\standalone.bat\")) {",
          "  $jbossVersion = (& \"$env:JBOSS_HOME\\bin\\standalone.bat\" --version 2>&1) -match '\\d+\\.\\d+\\.\\d+' | Select-Object -First 1",
          "}",
          "if ($jbossVersion) {",
          "  if (Version-LT $jbossVersion $latestJBoss) {",
          "    Write-Output \"JBoss: $jbossVersion (obsolete, latest $latestJBoss)\"",
          "  } else {",
          "    Write-Output \"JBoss: $jbossVersion (ok)\"",
          "  }",
          "} else {",
          "  Write-Output \"JBoss: not installed\"",
          "}",
          "",
          "# PowerShell 7 – scrape latest from Microsoft docs",
          "$latestPS7 = $null",
          "try {",
          "  $html = Invoke-WebRequest -Uri \"https://learn.microsoft.com/en-us/powershell/scripting/install/install-powershell-on-windows\" -UseBasicParsing",
          "  if ($html.Content -match 'PowerShell-(\\d+\\.\\d+\\.\\d+)-win-x64.msi') {",
          "    $latestPS7 = $matches[1]",
          "  }",
          "} catch {",
          "  Write-Warning \"Could not fetch latest PowerShell 7 version, skipping comparison.\"",
          "}",
          "$psVersion = $PSVersionTable.PSVersion.ToString()",
          "if ($latestPS7) {",
          "  if (Version-LT $psVersion $latestPS7) {",
          "    Write-Output \"PowerShell 7: $psVersion (obsolete, latest $latestPS7)\"",
          "  } else {",
          "    Write-Output \"PowerShell 7: $psVersion (ok)\"",
          "  }",
          "} else {",
          "  Write-Output \"PowerShell 7: $psVersion (no latest available)\"",
          "}",
          "",
          "# Python – scrape latest from python.org",
          "$latestPython = $null",
          "try {",
          "  $html = Invoke-WebRequest -Uri \"https://www.python.org/downloads/\" -UseBasicParsing",
          "  if ($html.Content -match 'Download Python ([0-9]+\\.[0-9]+\\.[0-9]+)') {",
          "    $latestPython = $matches[1]",
          "  }",
          "} catch {",
          "  Write-Warning \"Could not fetch latest Python version, skipping comparison.\"",
          "}",
          "$pythonVersion = (python --version 2>&1) -replace 'Python (.*)', '$1'",
          "if ($pythonVersion -match '\\d+\\.\\d+\\.\\d+') {",
          "  if ($latestPython) {",
          "    if (Version-LT $pythonVersion $latestPython) {",
          "      Write-Output \"Python: $pythonVersion (obsolete, latest $latestPython)\"",
          "    } else {",
          "      Write-Output \"Python: $pythonVersion (ok)\"",
          "    }",
          "  } else {",
          "    Write-Output \"Python: $pythonVersion (no latest available)\"",
          "  }",
          "} else {",
          "  Write-Output \"Python: not installed\"",
          "}"
        ]
      }
    }
  ]
}
